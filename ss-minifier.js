const fs = require('fs-extra');
const minify = require('html-minifier').minify;
const path = require('path');

const dist = 'dist/prerender/';

let orgSize = 0;
let newSize = 0;

fs.readdir(dist, (err, files) => {
  if(err){
    console.log(err);
    return;
  }
  Promise.all(files.map(async file => {
    const filePath = path.join(dist, file);
    const fileStats = await fs.stat(filePath);

    if(fileStats.isDirectory()){
      return;
    }

    if(path.extname(filePath) !== ".html"){
      return;
    }

    let buf = await fs.readFile(filePath);

    let originalValue = buf.toString();
    let minifiedValue = minify(originalValue, {
      caseSensitive: false,
      collapseBooleanAttributes: true,
      collapseInlineTagWhitespace: false,
      collapseWhitespace: true,
      conservativeCollapse: false,
      decodeEntities: true,
      html5: true,
      includeAutoGeneratedTags: false,
      keepClosingSlash: false,
      minifyCSS: true,
      minifyJS: true,
      preserveLineBreaks: false,
      preventAttributesEscaping: false,
      processConditionalComments: true,
      processScripts: ["text/html"],
      removeAttributeQuotes: true,
      removeComments: true,
      removeEmptyAttributes: true,
      removeEmptyElements: false,
      removeOptionalTags: true,
      removeRedundantAttributes: true,
      removeScriptTypeAttributes: true,
      removeStyleLinkTypeAttributes: true,
      removeTagWhitespace: true,
      sortAttributes: true,
      sortClassName: true,
      trimCustomFragments: true,
      useShortDoctype: true
    });

    orgSize += originalValue.length;
    newSize += minifiedValue.length;

    minifiedValue = "<!--simplyalec.com-->" + minifiedValue + "<!--prod:" + new Date().toISOString() + "-->";

    await fs.writeFile(filePath, minifiedValue);
    console.log("Minified " + filePath + ".")
  })).then(() => {
    const diff = orgSize - newSize;
    const savings = orgSize ? (100 * diff / orgSize).toFixed(2) : 0;
    console.log("[SS] Successfully minified files." +
      ". Original size: " + orgSize +
      ". Minified size: " + newSize +
      ". Savings: " + diff + " (" + savings + "%)");
  }).catch(e => {
    console.log(e);
    process.exit(1);
  });
});
